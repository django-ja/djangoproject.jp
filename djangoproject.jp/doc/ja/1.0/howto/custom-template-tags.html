<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>テンプレートタグやフィルタを自作する &mdash; Django v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.0',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="contents" title="Global table of contents" href="../contents.html" />
    <link rel="index" title="Global index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Django v1.0 documentation" href="../index.html" />
    <link rel="up" title="HOWTO ガイド" href="index.html" />
    <link rel="next" title="カスタムのストレージシステムを作成する" href="custom-file-storage.html" />
    <link rel="prev" title="カスタムのモデルフィールド" href="custom-model-fields.html" />
  </head>
  <body>
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../index.html">Django v1.0 documentation</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../index.html">ホーム</a>  |
        <a title="Table of contents" href="../contents.html">目次</a>  |
        <a title="Global index" href="../genindex.html">索引</a>  |
        <a title="Search" href="../modindex.html">モジュール一覧</a>
      </div>
      <div class="nav">
    &laquo; <a href="custom-model-fields.html" title="カスタムのモデルフィールド">前へ</a> 
     |
    <a href="index.html" title="HOWTO ガイド" accesskey="U">上へ</a>
   |
    <a href="custom-file-storage.html" title="カスタムのストレージシステムを作成する">次へ</a> &raquo;</div>
    </div>
    
    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="howto-custom-template-tags">
            
  
  <div class="section" id="s-id1">
<span id="s-howto-custom-template-tags"></span><h1>テンプレートタグやフィルタを自作する<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">revision-up-to:</th><td class="field-body">8961 (1.0)</td>
</tr>
</tbody>
</table>
<div class="section" id="s-id2">
<h2>はじめに<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Django テンプレートシステムには、広範な <a class="reference external" href="../ref/templates/builtins.html#ref-templates-builtins"><em>組み込みタグとフィルタ</em></a> が付属していて、アプリケーションのプレゼンテーショ
ンロジックに纏わる問題を解決できます。とはいえ、コアのテンプレートタグ
プリミティブだけでは、要求を満たせない場合もあります。そういう場合のために、
テンプレートエンジンを拡張できます。Python で自作のタグやフィルタを書き、
テンプレート上で <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></tt> タグを使って使えるのです。</p>
<div class="section" id="s-id3">
<h3>コードの配置<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>カスタムのテンプレートタグやフィルタは Django のアプリケーション内に置きま
す。既存のアプリケーションに関連があるのなら、そのアプリケーションにバンド
ルすればよいでしょう。そうでなければ、コードを入れておくための新たなアプリ
ケーションを作成します。</p>
<p>アプリケーション内には、 <tt class="docutils literal"><span class="pre">templatetags</span></tt> ディレクトリを置かねばなりません。
このディレクトリは、 <tt class="docutils literal"><span class="pre">models.py</span></tt> や <tt class="docutils literal"><span class="pre">views.py</span></tt> などと同じ階層に置きます。
<tt class="docutils literal"><span class="pre">templatetags</span></tt> がなければ、作成してください。ディレクトリ内に
<tt class="docutils literal"><span class="pre">__init__.py</span></tt> を置いて、パッケージ化するのを忘れないでください。</p>
<p>カスタムのタグやフィルタは、 <tt class="docutils literal"><span class="pre">templatetags</span></tt> ディレクトリの下に置きます。
モジュールファイルの名前は、あとでタグをロードするときに使う名前にします。
ですから、他のアプリケーションのカスタムタグやフィルタと名前が衝突しないよ
う、よく注意して名前を決めましょう。</p>
<p><tt class="docutils literal"><span class="pre">poll_extras.py</span></tt> という名前のファイルに自作のタグ／フィルタを入れているの
なら、アプリケーションのレイアウトは以下のようになるでしょう:</p>
<pre>polls/
    models.py
    templatetags/
        __init__.py
        poll_extras.py
    views.py</pre>
<p>そして、テンプレートでは以下のようにしてロードします:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">poll_extras</span> <span class="cp">%}</span>
</pre></div>
<p>あるアプリケーションのカスタムタグを <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></tt> で呼び出せるようにする
には、そのアプリケーションを <a class="reference external" href="../ref/settings.html#setting-INSTALLED_APPS"><tt class="xref docutils literal"><span class="pre">INSTALLED_APPS</span></tt></a> にいれておかねばなり
ません。これはセキュリティ上の制約です: こうすることで、一つのコンピュータ
にたくさんのテンプレートライブラリのコードを置きながら、個々の Django イン
ストールがライブラリに安全にアクセスできるようにします。</p>
<p><tt class="docutils literal"><span class="pre">templatetags</span></tt> パッケージには、いくつでもモジュールを入れられます。
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">%}</span></tt> 文はアプリケーションの名前ではなく、 Python モジュール名
に対応したタグ／フィルタをロードするということを心に留めておいてください。</p>
<p>有効なタグライブラリを作るには、 <tt class="docutils literal"><span class="pre">register</span></tt> という名前のモジュールレベル
変数に <tt class="docutils literal"><span class="pre">template.Library</span></tt> のインスタンスを入れておかねばなりません。
このインスタンスには、全てのタグとフィルタが登録されます。そこで、モジュー
ルの一番上の方で、以下のコード:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
</pre></div>
<p>を実行しておいてください。</p>
<div class="admonition-behind-the-scenes admonition">
<p class="first admonition-title">舞台裏</p>
<p class="last">Django のデフォルトのフィルタやタグのソースコードには大量のサンプルが
収められています。ソースコードはそれぞれ
<tt class="docutils literal"><span class="pre">django/template/defaultfilters.py</span></tt> や
<tt class="docutils literal"><span class="pre">django/template/defaulttags.py</span></tt> にあります。</p>
</div>
</div>
<div class="section" id="s-id4">
<span id="s-writing-custom-template-filters"></span><h3>カスタムのテンプレートフィルタ<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>カスタムフィルタは単なる Python の関数で、一つまたは二つの引数をとります:</p>
<ul class="simple">
<li>テンプレート変数 (入力) の値。文字列とは限りません。</li>
<li>引数の値。デフォルトを持たせたり、無視させたりできます。</li>
</ul>
<p>を取ります。例えば、フィルタ <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">var|foo:&quot;bar&quot;</span> <span class="pre">}}</span></tt> では、フィルタ <tt class="docutils literal"><span class="pre">foo</span></tt>
はテンプレート変数 <tt class="docutils literal"><span class="pre">var</span></tt> と引数 <tt class="docutils literal"><span class="pre">&quot;bar&quot;</span></tt> を受け取ります。</p>
<p>フィルタ関数は常に何かを返さねばなりません。フィルタ関数は例外を送出しては
ならず、失敗するときは暗黙のうちに失敗せねばなりません。エラーが生じた場合、
フィルタ関数は元の入力そのままか空文字列のうち、分かりやすい方を返すように
せねばなりません。</p>
<p>フィルタの定義の例を以下に示します:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="s">&quot;入力から arg の値を全て取り去る&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
<p>このフィルタは以下のように使います:</p>
<div class="highlight"><pre><span class="cp">{{</span> <span class="nv">somevariable</span><span class="o">|</span><span class="nf">cut</span><span class="s2">:&quot;0&quot;</span> <span class="cp">}}</span>
</pre></div>
<p>ほとんどのフィルタは引数を取りません。引数を取らない場合には関数から引数を
なくして下さい。例えば:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="c"># Only one argument.</span>
    <span class="s">&quot;入力をすべて小文字にする&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
<div class="section" id="s-id5">
<span id="s-template-filters-that-expect-strings"></span><h4>テンプレートフィルタに文字列だけを処理させる<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>第一引数に文字列しかとらないテンプレートフィルタを書きたければ、
<tt class="docutils literal"><span class="pre">stringfilter</span></tt> デコレータを使ってください。このフィルタは、フィルタ処理の
関数を呼び出す前に、第一引数のオブジェクトを文字列に変換します:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="kn">import</span> <span class="n">stringfilter</span>

<span class="nd">@stringfilter</span>
<span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
<p>こうすれば、例えばフィルタに整数型を渡したとしても、(整数型に <tt class="docutils literal"><span class="pre">lower()</span></tt>
がないために) <tt class="docutils literal"><span class="pre">AttributeError</span></tt> が送出されるようなことはありません。</p>
</div>
<div class="section" id="s-id6">
<span id="s-registering-custom-filters"></span><h4>カスタムフィルタを登録する<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>フィルタ定義を書き終えたら、 Django テンプレート言語で使えるようにするため
に <tt class="docutils literal"><span class="pre">Library</span></tt> インスタンスに登録する必要があります:</p>
<div class="highlight"><pre><span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">Library.filter()</span></tt> は二つの引数を取ります:</p>
<ol class="arabic simple">
<li>フィルタの名前。文字列です。</li>
<li>コンパイル関数。(関数名の文字列ではなく) Python 関数です。</li>
</ol>
<p>バージョン 2.4 以上の Python を使っているのなら、 <tt class="docutils literal"><span class="pre">register.filter()</span></tt>
デコレータを使えます:</p>
<div class="highlight"><pre><span class="nd">@register.filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;cut&#39;</span><span class="p">)</span>
<span class="nd">@stringfilter</span>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="nd">@register.filter</span>
<span class="nd">@stringfilter</span>
<span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>
<p>上の例の下の定義のようにして <tt class="docutils literal"><span class="pre">name</span></tt> 引数を省略すると、 Django は関数名を
そのままフィルタ名として使います。</p>
</div>
<div class="section" id="s-id7">
<span id="s-filters-and-auto-escaping"></span><h4>フィルタと自動エスケープ<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<span class="title">Django 1.0 で新たに登場しました.</span> </div>
<p>カスタムフィルタを書く場合、フィルタが Django の自動エスケープとどう関わっ
ているかに少し配慮しておく必要があります。まず、テンプレートのコード内では、
3 種類の文字列が受け渡しされています:</p>
<ul>
<li><p class="first"><strong>生の文字列</strong> は、 Python ネイティブの <tt class="docutils literal"><span class="pre">str</span></tt> や <tt class="docutils literal"><span class="pre">unicode</span></tt> 型の
オブジェクトです。出力時、自動エスケープが有効であればエスケープされ、
そうでなければ変更されません。</p>
</li>
<li><p class="first"><strong>safe 文字列</strong> は、出力時にさらなるエスケープ処理を行わなくてもよ
い文字列です。safe 文字列は、必要なエスケープが済んでいる文字列です。
クライアント側でそのまま解釈されるべき生の HTML を含んだ文字列を表現
するのに使われます。</p>
<p>内部的には、これらの文字列は <tt class="docutils literal"><span class="pre">SafeString</span></tt> や <tt class="docutils literal"><span class="pre">SafeUnicode</span></tt> 型で表
現されています。 <tt class="docutils literal"><span class="pre">SafeString</span></tt> と <tt class="docutils literal"><span class="pre">SafeUnicode</span></tt> は <tt class="docutils literal"><span class="pre">SafeData</span></tt> を
共通の基底クラスに持つので、以下のようにすれば判別できます:</p>
<pre>if isinstance(value, SafeData):
    # "safe" 文字列を扱う処理をここに</pre>
</li>
<li><p class="first"><strong>&quot;エスケープが必要&quot; であるとマークされている文字列</strong> は、
<tt class="docutils literal"><span class="pre">autoescape</span></tt> ブロックの指定に関係なく、必ずエスケープされます。
マークされている文字列は、自動エスケープの設定に関係なく、一度だけエ
スケープ処理を受けます。</p>
<p>内部的には、エスケープ必要文字列は、 <tt class="docutils literal"><span class="pre">EscapeString</span></tt> や
<tt class="docutils literal"><span class="pre">EscapeUnicode</span></tt> 型で表現されています。通常、これらの型のことを気に
する必要はありません。 <tt class="docutils literal"><span class="pre">EscapeString</span></tt> や <tt class="docutils literal"><span class="pre">EscapeUnicode</span></tt> は、
<tt class="docutils literal"><span class="pre">escape</span></tt> フィルタの実装のために用意されています。</p>
</li>
</ul>
<p>テンプレートフィルタのコードは、以下の二つのうちどちらかに落ち着きます:</p>
<ol class="arabic">
<li><p class="first">フィルタコードの出力が、 HTML 出力として安全でない文字 (<tt class="docutils literal"><span class="pre">&lt;</span></tt>,
<tt class="docutils literal"><span class="pre">&gt;</span></tt>, <tt class="docutils literal"><span class="pre">'</span></tt>, <tt class="docutils literal"><span class="pre">&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&amp;</span></tt>) を含まない場合。この場合、自動エスケー
プの処理は全て Django に任せられます。必要なのは、フィルタ関数の
<tt class="docutils literal"><span class="pre">is_safe</span></tt> 属性に  <tt class="xref docutils literal"><span class="pre">True</span></tt> を設定しておくことだけです:</p>
<div class="highlight"><pre><span class="nd">@register.filter</span>
<span class="k">def</span> <span class="nf">myfilter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span>
<span class="n">myfilter</span><span class="o">.</span><span class="n">is_safe</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>この属性を設定しておくと、このフィルタは「安全な」文字列を渡したとき
には出力は「安全な」ままであり、「安全でない」文字列を渡した時には、
必要に応じて自動的にエスケープします。</p>
<p><tt class="docutils literal"><span class="pre">is_safe</span></tt> は、「このフィルタは安全 (safe) であり、安全でない HTML
を生成する危険性がない」という意味だと考えてください。</p>
<p><tt class="docutils literal"><span class="pre">is_safe</span></tt> が必要なのは、通常の文字列操作で、 <tt class="docutils literal"><span class="pre">SafeData</span></tt> オブジェ
クトを  <tt class="docutils literal"><span class="pre">str</span></tt> や <tt class="docutils literal"><span class="pre">unicode</span></tt> オブジェクトに変換するものが数多くあ
るためです。全てを try と catch で拾うのは難しいので、 Django はフィ
ルタ処理が完了した時点でダメージを回復する戦略を取っています。</p>
<p>例えば、入力の末尾に <tt class="docutils literal"><span class="pre">xx</span></tt> を追加するようなフィルタを書くとします。
このフィルタは危険な HTML 文字を出力しないので、フィルタ関数を
<tt class="docutils literal"><span class="pre">is_safe</span></tt> でマークしておきます:</p>
<div class="highlight"><pre><span class="nd">@register.filter</span>
<span class="k">def</span> <span class="nf">add_xx</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">xx&#39;</span> <span class="o">%</span> <span class="n">value</span>
<span class="n">add_xx</span><span class="o">.</span><span class="n">is_safe</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>このフィルタをテンプレート上の自動エスケープが有効な部分で使うと、
Django は &quot;safe&quot; にマークされていない入力の時にフィルタの出力をエス
ケープします。</p>
<p>デフォルトでは、  <tt class="docutils literal"><span class="pre">is_safe</span></tt> は  <tt class="xref docutils literal"><span class="pre">False</span></tt> なので、 <tt class="docutils literal"><span class="pre">is_safe</span></tt> が
必要でなければ無視してかまいません。</p>
<p>フィルタを作成するときには、フィルタが本当に安全な文字を安全なままに
出力するのかをよく考えてください。例えば、フィルタが文字を <em>削除</em> す
る場合、出力結果に、対応の取れていないタグや不完全なエンティティ表現
が意図せず混じる可能性があります。例えば、 <tt class="docutils literal"><span class="pre">&gt;</span></tt> を入力から削ってし
まうと、 <tt class="docutils literal"><span class="pre">&lt;a&gt;</span></tt> の出力は  <tt class="docutils literal"><span class="pre">&lt;a</span></tt> になってしまい、問題を起こさないよ
うにするためには、出力をエスケープせねばならなくなってしまいます。同
様に、セミコロン (<tt class="docutils literal"><span class="pre">;</span></tt>) を除去すると、 <tt class="docutils literal"><span class="pre">&amp;amp;</span></tt> は <tt class="docutils literal"><span class="pre">&amp;amp</span></tt> になっ
てしまい、有効なエンティティ表現でないために、エスケープが必要になっ
てしまいます。たいていのケースでは、このようなトリッキーなことは起こ
りませんが、コードをレビューする際にはこの手のことが起こらないように
よく確認してください。</p>
</li>
<li><p class="first">もう一つは、フィルタのコードで必要なエスケープを行うというものです。
出力に新たな HTML マークアップを含めたい場合に必要です。この場合、
出力する HTML マークアップがそれ以上エスケープされないよう、出力を
safe にする必要があるので、入力は自分で扱わねばなりません。</p>
<p>出力を safe 文字列としてマークするには、
<tt class="xref docutils literal"><span class="pre">mark_safe()</span></tt> を使います。</p>
<p>ただし、注意してください。出力を safe であるとマークするだけでは十分
ではありません。出力が本当に safe <em>である</em> ことを保証せねばならず、
それは自動エスケープが有効か無効かで変わります。自動エスケープがオン
でもオフでも使え、テンプレートの作者が簡単に扱えるフィルタを書くのが
理想です。</p>
<p>現在の自動エスケープ状態をフィルタに教えるには、関数の
<tt class="docutils literal"><span class="pre">needs_autoescape</span></tt> 属性を <tt class="xref docutils literal"><span class="pre">True</span></tt> に設定します (この属性を設定
しない場合のデフォルト値は <tt class="xref docutils literal"><span class="pre">False</span></tt> です)。 <tt class="docutils literal"><span class="pre">needs_autoescape</span></tt>
を <tt class="xref docutils literal"><span class="pre">True</span></tt> にすると、フィルタ関数には <tt class="docutils literal"><span class="pre">autoescape</span></tt> という追加の引
数が渡されます。自動エスケープが有効な状況でフィルタが呼び出されると、
<tt class="docutils literal"><span class="pre">autoescape</span></tt> には <tt class="xref docutils literal"><span class="pre">True</span></tt> が渡され、そうでない場合には <tt class="xref docutils literal"><span class="pre">False</span></tt>
が渡されます。</p>
<p>例えば、文字列の先頭の文字を強調表示にするようなフィルタを書いてみま
しょう:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">conditional_escape</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>

<span class="k">def</span> <span class="nf">initial_letter_filter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">autoescape</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">first</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">autoescape</span><span class="p">:</span>
        <span class="n">esc</span> <span class="o">=</span> <span class="n">conditional_escape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">esc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&lt;strong&gt;</span><span class="si">%s</span><span class="s">&lt;/strong&gt;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">esc</span><span class="p">(</span><span class="n">first</span><span class="p">),</span> <span class="n">esc</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">initial_letter_filter</span><span class="o">.</span><span class="n">needs_autoescape</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>フィルタ関数の <tt class="docutils literal"><span class="pre">needs_autoescape</span></tt> 属性と <tt class="docutils literal"><span class="pre">autoescape</span></tt> キーワード
引数の存在によって、フィルタ関数は自身が呼び出されたときの自動エスケー
プ状態を検知できます。上の例では、 <tt class="docutils literal"><span class="pre">autoescape</span></tt> を使って、入力デー
タを <tt class="docutils literal"><span class="pre">django.utils.html.conditional_escape</span></tt> で処理するべきかどうか
判定しています。 (<tt class="docutils literal"><span class="pre">conditional_escape</span></tt> が不要の場合、 <tt class="docutils literal"><span class="pre">esc</span></tt> を
アイデンティティ関数にしています) <tt class="docutils literal"><span class="pre">conditional_escape()</span></tt> は
<tt class="docutils literal"><span class="pre">escape()</span></tt> に似ていますが、入力が <tt class="docutils literal"><span class="pre">SafeData</span></tt> インスタンスで
<strong>ない</strong> 場合にのみエスケープを適用します。 <tt class="docutils literal"><span class="pre">conditional_escape()</span></tt>
に <tt class="docutils literal"><span class="pre">SafeData</span></tt> を渡すと、データは変更されません。</p>
<p>最後に、上の例では、フィルタ結果を <tt class="docutils literal"><span class="pre">mark_safe</span></tt> で safe にマークし
て、出力結果の HTML をこれ以上エスケープせず、最終的なテンプレート出
力に挿入させています。</p>
<p>このケースでは、 <tt class="docutils literal"><span class="pre">is_safe</span></tt> 属性について触れていません (実際には、
設定しても何の影響もありません)。自動エスケープの問題を手動で解決し
て、 safe 文字列を返している場合、 <tt class="docutils literal"><span class="pre">is_safe</span></tt> 属性は何ら影響をもた
ないのです。</p>
</li>
</ol>
</div>
</div>
<div class="section" id="s-id8">
<span id="s-writing-custom-template-tags"></span><h3>カスタムテンプレートタグを書く<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>タグはフィルタよりもやや複雑です。というのも、タグは何でもできるからです。</p>
<div class="section" id="s-id9">
<span id="s-a-quick-overview"></span><h4>テンプレートタグの概要<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>前に、このドキュメントで、テンプレートシステムはコンパイルとレンダリングと
いう二段階のプロセスで動作すると説明しました。カスタムテンプレートタグを定
義するには、コンパイルがどのように行われ、レンダリングがどのように行われる
かを指定する必要があります。</p>
<p>テンプレートをコンパイルする時、Django は元のテンプレートテキストを「ノード
(node)」に分割します。各ノードは <tt class="docutils literal"><span class="pre">django.template.Node</span></tt> のインスタンスで
あり、 <tt class="docutils literal"><span class="pre">render()</span></tt> メソッドを持ちます。コンパイル済みのテンプレートは単な
る <tt class="docutils literal"><span class="pre">Node</span></tt> オブジェクトの集まりに過ぎません。コンパイル済みのテンプレート
オブジェクトに対して <tt class="docutils literal"><span class="pre">render()</span></tt> を呼び出すと、テンプレートは指定されたコ
ンテキストを使ってノードリストの各 <tt class="docutils literal"><span class="pre">Node</span></tt> に対して <tt class="docutils literal"><span class="pre">render()</span></tt> を呼び出
します。戻り値は全て連結され、テンプレートからの出力になります。</p>
<p>従って、カスタムテンプレートタグを定義するには、元のテンプレートタグをどう
やって <tt class="docutils literal"><span class="pre">Node</span></tt> (コンパイル関数: compilation function) に変換し、個々のノー
ドの <tt class="docutils literal"><span class="pre">render()</span></tt> メソッドが何をするかを指定する必要があります。</p>
</div>
<div class="section" id="s-id10">
<span id="s-writing-the-compilation-function"></span><h4>コンパイル関数を書く<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>テンプレートタグに到達するたびに、テンプレートパーザはタグの内容とパーザオ
ブジェクト自体を引数にしてある Python 関数を呼び出します。この関数はタグの
内容に応じて <tt class="docutils literal"><span class="pre">Node</span></tt> インスタンスを返すようになっています。</p>
<p>例えば、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">current_time</span> <span class="pre">%}</span></tt> というタグを書いてみましょう。このタグは現
在の日付／時刻を表示し、そのフォーマットはタグの引数に指定した
<a class="reference external" href="http://www.python.jp/doc/release/lib/module-time.html#l2h-1915">strftime の文法</a> に従うとします。何をおいてもタグの構文をまず決めておくの
がよいでしょう。我々の例では、タグは以下のように使われるものとしましょう:</p>
<div class="highlight"><pre><span class="nt">&lt;p&gt;</span>The time is <span class="cp">{%</span> <span class="k">current_time</span> <span class="s2">&quot;%Y-%m-%d %I:%M %p&quot;</span> <span class="cp">%}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
<p>以下の関数は、パラメタを取り出して、 <tt class="docutils literal"><span class="pre">Node</span></tt> オブジェクトを生成します:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># split_contents() knows not to split quoted strings.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">format_string</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires a single argument&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span>
    <span class="k">return</span> <span class="n">CurrentTimeNode</span><span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
<p>注意:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">parser</span></tt> はテンプレートパーザオブジェクトです。上の例では特に必要で
はありません。</li>
<li><tt class="docutils literal"><span class="pre">token.contents</span></tt> はタグの中身を表す文字列です。上の例では
<tt class="docutils literal"><span class="pre">'current_time</span> <span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;'</span></tt> です。</li>
<li><tt class="docutils literal"><span class="pre">token.split_contents()</span></tt> メソッドは、クオートされた文字列はそのまま
にして、引数をスペースで分割します。 <tt class="docutils literal"><span class="pre">token.contents.split()</span></tt> の方
が直接的なように思えますが、クオート中の空白も含め、 <em>全ての</em> スペー
スを区切りとみなすので、これは頑健な方法とはいえません。常に
<tt class="docutils literal"><span class="pre">token.split_contents()</span></tt> を使った方がよいでしょう。</li>
<li>この関数は、何らかの構文エラーが生じた場合、分かりやすいメッセージ付
きで <tt class="docutils literal"><span class="pre">django.template.TemplateSyntaxError</span></tt> を送出せねばなりません。</li>
<li><tt class="docutils literal"><span class="pre">TemplateSyntaxError</span></tt> 例外は <tt class="docutils literal"><span class="pre">tag_name</span></tt> 変数を使っています。
エラーメッセージにタグの名前をハードコードしてはなりません。なぜなら
関数とタグの名前がカップリングしてしまうからです。タグに引数があって
もなくても、 <tt class="docutils literal"><span class="pre">token.contents.split()[0]</span></tt> は常にタグの名前と同じです。</li>
<li>この関数は、タグの処理に必要な全ての情報を持った <tt class="docutils literal"><span class="pre">CurrentTimeNode</span></tt>
を返します。この例の場合、タグには引数 <tt class="docutils literal"><span class="pre">&quot;%Y-%m-%d</span> <span class="pre">%I:%M</span> <span class="pre">%p&quot;</span></tt> が渡さ
れただけです。テンプレートタグの先頭や末尾のクオートは
<tt class="docutils literal"><span class="pre">format_string[1:-1]</span></tt> ではぎ取られています。</li>
<li>パージング処理は極めて低水準で実現されています。 Django の開発者達は、
EBNF 文法のようなテクニックを使って、このパージングシステムの上に小さ
なフレームワークを書く実験を重ねて来ましたが、その結果はテンプレート
エンジンをひどく低速にしてしまいました。というわけで、低水準にしてい
るのは、それが最も高速だからです。</li>
</ul>
</div>
<div class="section" id="s-id11">
<span id="s-writing-the-renderer"></span><h4>レンダラを書く<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>カスタムタグを書く二つめのステップは、 <tt class="docutils literal"><span class="pre">render()</span></tt> メソッドを持つ <tt class="docutils literal"><span class="pre">Node</span></tt>
クラスの定義です。</p>
<p>上の例の続きとして話を勧めると、 <tt class="docutils literal"><span class="pre">CurrentTimeNode</span></tt> を定義する必要がありま
す:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">class</span> <span class="nc">CurrentTimeNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
</pre></div>
<p>注意:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">__init__()</span></tt> は <tt class="docutils literal"><span class="pre">do_current_time()</span></tt> から <tt class="docutils literal"><span class="pre">format_string</span></tt> を受け
取ります。 <tt class="docutils literal"><span class="pre">Node</span></tt> へのオプション／パラメタ／引数は、常に
<tt class="docutils literal"><span class="pre">__init__()</span></tt> を介して渡すようにしてください。</li>
<li>実際の処理を実現するのは <tt class="docutils literal"><span class="pre">render()</span></tt> メソッドです。</li>
<li><tt class="docutils literal"><span class="pre">render()</span></tt> は <tt class="docutils literal"><span class="pre">TemplateSyntaxError</span></tt> やその他の例外を送出してはな
りません。フィルタと同様、失敗は暗黙のうちに処理されるようにせねばな
りません、</li>
</ul>
<p>一つのテンプレートは、繰り返しパージングされることなく複数のコンテキストを
レンダリングすることがあるので、このようなコンパイルとレンダリングの脱カッ
プリングは究極的には効率的なテンプレートシステムを実現します。</p>
</div>
<div class="section" id="s-id12">
<span id="s-auto-escaping-considerations"></span><h4>自動エスケープについての注意点<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<span class="title">Django 1.0 で新たに登場しました.</span> </div>
<p>テンプレートタグの出力は、自動エスケープフィルタで自動的に処理され
<em>ません</em> 。とはいえ、テンプレートタグを書くときには、二つのことを心に留めて
置く必要があります。</p>
<p>まず、テンプレートタグの <tt class="docutils literal"><span class="pre">render()</span></tt> が結果をコンテキスト変数に保存する場
合 (文字列でそのまま返さない場合) には、必要なら <tt class="docutils literal"><span class="pre">mark_safe()</span></tt> を呼び出し
ておく必要があります。その変数を最終的にレンダした時点で、変数は自動エスケー
プの設定の影響を受けるので、自動エスケープから保護したい変数はそのようにマー
クしておく必要があるのです。</p>
<p>また、テンプレートタグがサブレンダリングのために新たなコンテキストを生成す
る場合、そのコンテキスト変数に <tt class="docutils literal"><span class="pre">autoescape</span></tt> 属性を設定してください。
<tt class="docutils literal"><span class="pre">Context</span></tt> クラスの <tt class="docutils literal"><span class="pre">__init__</span></tt> メソッドは、この目的のために、
<tt class="docutils literal"><span class="pre">autoescape</span></tt> というパラメタをとれるようになっています。例えば:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">new_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span><span class="s">&#39;var&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">},</span> <span class="n">autoescape</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">autoescape</span><span class="p">)</span>
    <span class="c"># ... 新しいコンテキストで何かする ...</span>
</pre></div>
<p>このような状況はあまりありませんが、テンプレートタグ内で別のテンプレートを
レンダする場合には便利です。例えば:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;small_fragment.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">Context</span><span class="p">({</span><span class="s">&#39;var&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">},</span> <span class="n">autoescape</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">autoescape</span><span class="p">))</span>
</pre></div>
<p>上の例で、 <tt class="docutils literal"><span class="pre">context.autoescape</span></tt> の値を渡し忘れると、出力の変数は
<em>全て</em> 自動エスケープされてしまい、その結果、テンプレートタグを
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">autoescape</span> <span class="pre">off</span> <span class="pre">%}</span></tt> ブロック内で使った場合の出力が期待とは違うものになっ
てしまいます。</p>
</div>
<div class="section" id="s-id13">
<span id="s-registering-the-tag"></span><h4>タグの登録<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>最後に、上の「カスタムテンプレートフィルタを書く」の節で説明したように、タ
グをモジュールの <tt class="docutils literal"><span class="pre">Library</span></tt> インスタンスに登録します:</p>
<div class="highlight"><pre><span class="n">register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s">&#39;current_time&#39;</span><span class="p">,</span> <span class="n">do_current_time</span><span class="p">)</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">tag()</span></tt> メソッドは二つの引数をとります:</p>
<ol class="arabic simple">
<li>テンプレートタグの名前、文字列です。省略すると、コンパイル関数の名前
を使います。</li>
<li>コンパイル関数。 Python の関数です (関数名を表す文字列ではありません)。</li>
</ol>
<p>フィルタの登録と同様、バージョン 2.4 以降の Python ではこの関数をデコレータ
として使えます:</p>
<pre>@register.tag(name="current_time")
def do_current_time(parser, token):
    # ...

@register.tag
def shout(parser, token):
    # ...</pre>
<p>上の例の下の定義のようにして <tt class="docutils literal"><span class="pre">name</span></tt> 引数を省略すると、 Django は関数名を
そのままフィルタ名として使います。</p>
</div>
<div class="section" id="s-id14">
<span id="s-passing-template-variables-to-the-tag"></span><h4>テンプレート変数をタグに渡す<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">token.split_contents()</span></tt> を使えば、テンプレートタグにいくつでも引数を渡せ
ますが、引数はすべて文字列リテラルになってしまいます。そのため、テンプレー
トタグの引数に動的なコンテンツ (テンプレート変数) を渡すには、もうひと工夫
必要です。</p>
<p>先に挙げた例では、現在時刻を文字列にフォーマットして文字列で値を返していま
したが、今度は以下のように <tt class="docutils literal"><span class="pre">DateTimeField</span></tt> の値を渡してテンプレートタグに
日付と時刻をフォーマットさせたいとしましょう:</p>
<div class="highlight"><pre><span class="nt">&lt;p&gt;</span>この投稿が最後に更新されたのは<span class="cp">{%</span> <span class="k">format_time</span> <span class="nv">blog_entry.date_updated</span> <span class="s2">&quot;%Y-%m-%d %I:%M %p&quot;</span> <span class="cp">%}</span> です。<span class="nt">&lt;/p&gt;</span>
</pre></div>
<p>まず、 <tt class="docutils literal"><span class="pre">token.split_contents()</span></tt> は以下の 3 つの値を返します:</p>
<ol class="arabic simple">
<li>タグ名である <tt class="docutils literal"><span class="pre">format_time</span></tt> 。</li>
<li><tt class="docutils literal"><span class="pre">blog_entry.date_updated</span></tt> という <em>文字列</em> 。</li>
<li>フォーマット文字列 &quot;%Y-%m-%d %I:%M %p&quot; 。 <tt class="docutils literal"><span class="pre">split_contents()</span></tt> は、
文字列リテラルの先頭と末尾にあるクオート文字を除去しません。</li>
</ol>
<p>今度は、タグの定義は以下のようになります:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="k">def</span> <span class="nf">do_format_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># split_contents() はクオート付き文字列を分解しない</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split_contents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires exactly two arguments&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span>
    <span class="k">return</span> <span class="n">FormatTimeNode</span><span class="p">(</span><span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
<p>レンダラの方も変更して、 <tt class="docutils literal"><span class="pre">blog_entry</span></tt> オブジェクトの <tt class="docutils literal"><span class="pre">date_updated</span></tt> プ
ロパティの実際の中身を取り出せるようにせねばなりません。これは
<tt class="docutils literal"><span class="pre">django.template</span></tt> の <tt class="docutils literal"><span class="pre">resolve_varialbe()</span></tt> で実現します。
<tt class="docutils literal"><span class="pre">resolve_variable()</span></tt> には、変数名と <tt class="docutils literal"><span class="pre">render</span></tt> メソッドを介して渡される現
在のコンテキストを指定します:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">resolve_variable</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">class</span> <span class="nc">FormatTimeNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_to_be_formatted</span> <span class="o">=</span> <span class="n">date_to_be_formatted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">actual_date</span> <span class="o">=</span> <span class="n">resolve_variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_to_be_formatted</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">actual_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">template</span><span class="o">.</span><span class="n">VariableDoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
<p>これで、 <tt class="docutils literal"><span class="pre">resolve_variable</span></tt> は <tt class="docutils literal"><span class="pre">blog_entry.date_updated</span></tt> の値を解決して、
その値にしたがってフォーマット処理を行います。</p>
<div class="versionadded">
<span class="title">Django 1.0 で新たに登場しました.</span> </div>
<p>現在のページのコンテキストに、 <tt class="docutils literal"><span class="pre">Variable</span></tt> に渡した名前がなかった場合、
名前解決の際に <tt class="docutils literal"><span class="pre">VariableDoesNotExist</span></tt> 例外が送出されます。</p>
</div>
<div class="section" id="s-id15">
<span id="s-shortcut-for-simple-tags"></span><h4>簡単なタグへのショートカット<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>多くのテンプレートタグは、文字列やテンプレート変数への参照を単一の引数とし
て取り、入力引数や外部の何らかの情報に基づいて処理を行った後、文字列を返し
ます。例えば、上で書いた <tt class="docutils literal"><span class="pre">current_time</span></tt> タグがその例で、フォーマット文字
列を指定して、時刻を文字列の形で返すようになっています。</p>
<p>この種のタグを簡単に作成できるようにするため、 Django では <tt class="docutils literal"><span class="pre">simple_tag</span></tt>
というヘルパー関数を提供しています。この関数は <tt class="docutils literal"><span class="pre">django.template.Library</span></tt>
のメソッドで、何らかの関数を引数にとり、その関数を <tt class="docutils literal"><span class="pre">render</span></tt> メソッドにラッ
プし、これまでに述べてきたいくつかのお作法を適用した後、テンプレートシステ
ムにタグを登録します。</p>
<p><tt class="docutils literal"><span class="pre">simple_tag</span></tt> を使うと、上の <tt class="docutils literal"><span class="pre">current_time</span></tt> 関数は以下のように書けます:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_string</span><span class="p">)</span>

<span class="n">register</span><span class="o">.</span><span class="n">simple_tag</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
</pre></div>
<p>Python 2.4 からは、デコレータ構文も使えます:</p>
<div class="highlight"><pre><span class="nd">@register.simple_tag</span>
<span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="n">format_string</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">simple_tag</span></tt> ヘルパ関数については、以下の点に注意してください:</p>
<ul class="simple">
<li>引数の個数チェックなどは関数の呼び出しの際に行われるので、わざわざ自
分でチェックしなくてもかまいません。</li>
<li>関数に渡される引数がクオートされている場合、クオートは自動的に取り去
られます。従って、関数は通常の文字列を受け取ることになります。</li>
<li>引数がテンプレート変数なら、関数に渡されるのは変数自体ではなく、
変数の現在値になります。</li>
</ul>
<p>テンプレートタグが現在のコンテキストにアクセスしなくてもよいのなら、
入力値を引数に取るような関数を定義し、 <tt class="docutils literal"><span class="pre">simple_tag</span></tt> ヘルパ関数を使うのが
一番簡単です。</p>
</div>
<div class="section" id="s-id16">
<span id="s-inclusion-tags"></span><h4>埋め込みタグ<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>テンプレートタグによくあるもう一つのタイプは、 <em>別の</em> テンプレートをレンダ
して表示するものです。例えば、 Django の admin インタフェースではカスタムの
テンプレートタグを使って「追加／変更」フォームページのボタンを表示していま
す。これらのボタンはいつも同じように表示されていますが、リンクのターゲット
は編集対象のオブジェクトによって変わります。従って、こうした処理は、小さな
テンプレートを使って現在のオブジェクトに応じた値を埋めるのが最良の方法と言
えます。 (admin の <tt class="docutils literal"><span class="pre">submit_raw</span></tt> がそのタグです)。</p>
<p>こうしたタグのことを 「埋め込みタグ (inclusion tag)」 と呼びます。</p>
<p>埋め込みタグの書き方を説明するには、例を挙げるのがベストでしょう。
<a class="reference external" href="../intro/tutorial01.html#creating-models"><em>チュートリアル</em></a> で作成した <tt class="docutils literal"><span class="pre">Poll</span></tt> オブジェクトを
例に、ある <tt class="docutils literal"><span class="pre">Poll</span></tt> オブジェクトに対する選択肢のリストを出力するようなタグ
を書いてみましょう。タグは以下のようになります:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">show_results</span> <span class="nv">poll</span> <span class="cp">%}</span>
</pre></div>
<p>出力は以下のようになります:</p>
<div class="highlight"><pre><span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li&gt;</span>First choice<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>Second choice<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;li&gt;</span>Third choice<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
<p>まず、引数を受け取って、対応するデータの辞書を生成するような関数を定義しま
す。ここで重要なのは、辞書を返さねばならず、それ以外の複雑なデータを返して
はならないということです。戻り値はテンプレートフラグメントをレンダするとき
のテンプレートコンテキストに使われます。例を示します:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">poll</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">poll</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;choices&#39;</span><span class="p">:</span> <span class="n">choices</span><span class="p">}</span>
</pre></div>
<p>次に、タグの出力をレンダする際に使うテンプレートを作成します。このテンプレー
トはタグ固有のもので、テンプレートデザイナではなくタグの開発者が書くべきも
のです。上の例に従えば、テンプレートはとても単純な形になります:</p>
<div class="highlight"><pre><span class="nt">&lt;ul&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">choices</span> <span class="cp">%}</span>
    <span class="nt">&lt;li&gt;</span> <span class="cp">{{</span> <span class="nv">choice</span> <span class="cp">}}</span> <span class="nt">&lt;/li&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
<p>さて、 <tt class="docutils literal"><span class="pre">Library</span></tt> オブジェクトの <tt class="docutils literal"><span class="pre">inclusion_tag()</span></tt> メソッドを呼び出して、
埋め込みタグを作成し、登録しましょう。上のテンプレートがテンプレートローダ
の検索対象ディレクトリ下にある <tt class="docutils literal"><span class="pre">result.html</span></tt> だとすると、タグの登録は以下
のようにして行います:</p>
<div class="highlight"><pre><span class="c"># Here, register is a django.template.Library instance, as before</span>
<span class="n">register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="s">&#39;results.html&#39;</span><span class="p">)(</span><span class="n">show_results</span><span class="p">)</span>
</pre></div>
<p>ここでも、 Python 2.4 のデコレータ構文を使えます。従って、関数を定義する時
点で下記のようにも書けます:</p>
<div class="highlight"><pre><span class="nd">@register.inclusion_tag</span><span class="p">(</span><span class="s">&#39;results.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">poll</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
<p>時として、埋め込みタグが大量の引数を取るようになっていて、テンプレートの作
者が全ての引数やその順番を管理しきれなくなるような場合があります。この問題
を解決するために、 Django では埋め込みタグに対して <tt class="docutils literal"><span class="pre">takes_context</span></tt> オプショ
ンを提供しています。テンプレートタグの作成時に <tt class="docutils literal"><span class="pre">takes_context</span></tt> を指定する
と、タグは必須の引数を取らなくなり、タグのラップしている Python 関数は単一
の引数を取るようになります。この引数には、タグが呼び出されたときのテンプレー
トコンテキストが入ります。</p>
<p>例えば、メインページに戻るためのリンクに使う <tt class="docutils literal"><span class="pre">home_link</span></tt> および
<tt class="docutils literal"><span class="pre">home_title</span></tt> という変数の入ったコンテキストの下で使う埋め込みタグを書いて
いるとしましょう。タグの Python 関数は以下のようになります:</p>
<div class="highlight"><pre><span class="c"># 最初の引数は *必ず* &quot;context&quot; と *呼ばねばなりません*</span>
<span class="k">def</span> <span class="nf">jump_link</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;link&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;home_link&#39;</span><span class="p">],</span>
        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;home_title&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="c"># Register the custom tag as an inclusion tag with takes_context=True.</span>
<span class="n">register</span><span class="o">.</span><span class="n">inclusion_tag</span><span class="p">(</span><span class="s">&#39;link.html&#39;</span><span class="p">,</span> <span class="n">takes_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)(</span><span class="n">jump_link</span><span class="p">)</span>
</pre></div>
<p>(関数の最初のパラメタは <em>必ず</em> <tt class="docutils literal"><span class="pre">context</span></tt> という名前に <em>せねばならない</em> の
で注意してください。)</p>
<p><tt class="docutils literal"><span class="pre">register.inclusion_tag()</span></tt> の行で、 <tt class="docutils literal"><span class="pre">takes_context=True</span></tt> を指定し、テン
プレートの名前を指定しています。 <tt class="docutils literal"><span class="pre">link.html</span></tt> テンプレートの中は以下のよう
になります:</p>
<div class="highlight"><pre>Jump directly to <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">link</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">title</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;</span>.
</pre></div>
<p>このカスタムタグを使う場合は常に、まずライブラリを呼び出しておき、下記のよ
うに引数なしでタグを呼び出します:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">jump_link</span> <span class="cp">%}</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">takes_context=True</span></tt> を使っている場合、テンプレートタグに引数を渡す必要は
ありません。タグが自動的にコンテキストにアクセスします。</p>
<p><tt class="docutils literal"><span class="pre">takes_context</span></tt> パラメタはデフォルトでは <tt class="xref docutils literal"><span class="pre">False</span></tt> です。この値を <em>True</em>
に設定すると、タグの引数にはコンテキストオブジェクトが渡されます。この点だ
けは前述の <tt class="docutils literal"><span class="pre">inclusion_tag</span></tt> の例と異なります。</p>
</div>
<div class="section" id="s-id17">
<span id="s-setting-a-variable-in-the-context"></span><h4>コンテキスト中の変数を設定する<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>上の例は、単に値を出力するという単純なものでした。一般的な話として、テンプ
レートタグが値を出力するだけでなく、テンプレート変数の値を設定できたりする
ともっと柔軟性が増すでしょう。そうすれば、テンプレートの作者はテンプレート
タグのつくり出す変数を再利用できるようになります。</p>
<p>コンテキスト中に変数を設定するには、 <tt class="docutils literal"><span class="pre">render()</span></tt> メソッドで渡されるコンテ
キストオブジェクトを辞書として代入するだけです。先程の <tt class="docutils literal"><span class="pre">CurrentTimeNode</span></tt>
を変更して、値を出力するのではなく <tt class="docutils literal"><span class="pre">current_time</span></tt> というテンプレート変数
を設定した例を示します:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CurrentTimeNode2</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;current_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">render()</span></tt> は空文字列を返していることに注意して下さい。 <tt class="docutils literal"><span class="pre">render()</span></tt>
は常に文字列を出力せねばなりません。全てのテンプレートタグが変数の設定
しかしなければ、 <tt class="docutils literal"><span class="pre">render()</span></tt> は空の文字列を返すだけです。</p>
<p>新しいバージョンのタグの使い方を示します:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">current_time</span> <span class="s2">&quot;%Y-%M-%d %I:%M %p&quot;</span> <span class="cp">%}</span><span class="nt">&lt;p&gt;</span>The time is <span class="cp">{{</span> <span class="nv">current_time</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
<p>ところで、 <tt class="docutils literal"><span class="pre">CurrentTimeNode2</span></tt> には問題があります: 変数名 <tt class="docutils literal"><span class="pre">current_time</span></tt>
がハードコードされているのです。これはすなわち、テンプレートの他の部分で
<tt class="docutils literal"><span class="pre">{{</span> <span class="pre">current_time</span> <span class="pre">}}</span></tt> を使わないようにせねばならないことを意味します。とい
うのも、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">current_time</span> <span class="pre">%}</span></tt> は変数の値を盲目的に上書きしてしまうからで
す。より綺麗な解法は、出力用の変数名を定義させるというものです:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">get_current_time</span> <span class="s2">&quot;%Y-%M-%d %I:%M %p&quot;</span> <span class="k">as</span> <span class="nv">my_current_time</span> <span class="cp">%}</span>
<span class="nt">&lt;p&gt;</span>The current time is <span class="cp">{{</span> <span class="nv">my_current_time</span> <span class="cp">}}</span>.<span class="nt">&lt;/p&gt;</span>
</pre></div>
<p>この機能を実現するには、コンパイル関数と <tt class="docutils literal"><span class="pre">Node</span></tt> の両方をリファクタして、
以下のようにせねばなりません:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">CurrentTimeNode3</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_string</span> <span class="o">=</span> <span class="n">format_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">do_current_time</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c"># This version uses a regular expression to parse tag contents.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Splitting by None == splitting by spaces.</span>
        <span class="n">tag_name</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag requires arguments&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;(.*?) as (\w+)&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag had invalid arguments&quot;</span> <span class="o">%</span> <span class="n">tag_name</span>
    <span class="n">format_string</span><span class="p">,</span> <span class="n">var_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">format_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">format_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">template</span><span class="o">.</span><span class="n">TemplateSyntaxError</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> tag&#39;s argument should be in quotes&quot;</span> <span class="o">%</span> <span class="n">tag_name</span>
    <span class="k">return</span> <span class="n">CurrentTimeNode3</span><span class="p">(</span><span class="n">format_string</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">var_name</span><span class="p">)</span>
</pre></div>
<p>ここでの違いは、 <tt class="docutils literal"><span class="pre">do_current_tume()</span></tt> がフォーマット文字列と変数名を取り、
<tt class="docutils literal"><span class="pre">CurrentTimeNode3</span></tt> に渡すという点です。</p>
</div>
<div class="section" id="s-parsing-until-another-block-tag">
<h4>Parsing until another block tag<a class="headerlink" href="#parsing-until-another-block-tag" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="s-id19">
<span id="s-id18"></span><h4>他のブロックタグに到達するまでパージングする<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>テンプレートタグは違いに連携させられます。例えば、標準の <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt>
というタグは、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt> までの全ての内容を出力しないようにしま
す。このようなテンプレートタグを作るには、コンパイル関数中で
<tt class="docutils literal"><span class="pre">parser.parse()</span></tt> を使います。</p>
<p>標準の <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt> タグの実装方法を示します:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">do_comment</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s">&#39;endcomment&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">CommentNode</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CommentNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">parser.parse()</span></tt> は「そこまで読み進める」ブロックタグからなるタプルを引数
にとります。 <tt class="docutils literal"><span class="pre">parser.parse()</span></tt> は <tt class="docutils literal"><span class="pre">django.template.NodeList</span></tt> のインスタ
ンスを返します。このインスタンスは、タプルに指定したブロックタグのいずれか
に到達する「より以前」に、パーザが出会った全ての <tt class="docutils literal"><span class="pre">Node</span></tt> オブジェクトから
なるリストです。</p>
<p>上の例の <tt class="docutils literal"><span class="pre">&quot;nodelist</span> <span class="pre">=</span> <span class="pre">parser.parse(('endcomment',))&quot;</span></tt> では、 <tt class="docutils literal"><span class="pre">nodelist</span></tt>
は <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt> から <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt> までの全てのノードからなる
リストになります。ただし、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt> や <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt>
自体は除きます。</p>
<p><tt class="docutils literal"><span class="pre">parser.parse()</span></tt> の呼び出し直後では、パーザはまだ <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt>
タグを「消費」していないので、コードから明示的に
<tt class="docutils literal"><span class="pre">parser.delete_first_token()</span></tt> を呼び出してやる必要があります。</p>
<p><tt class="docutils literal"><span class="pre">CommentNode.render()</span></tt> は単に空文字列を返します。その結果、
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt> と <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt> の間の内容は全て無視されます。</p>
</div>
<div class="section" id="s-id20">
<span id="s-parsing-until-another-block-tag-and-saving-contents"></span><h4>次のブロックタグまでパージングして、内容を保存する<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>前節の例では、 <tt class="docutils literal"><span class="pre">do_comment()</span></tt> は <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">comment</span> <span class="pre">%}</span></tt> から
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endcomment</span> <span class="pre">%}</span></tt> までの全ての内容を無視しています。このような処理に代え
て、ブロックタグ間のコードを使った処理も行えます。</p>
<p>例えば、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">upper</span> <span class="pre">%}</span></tt> というカスタムのテンプレートタグを定義して、
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endupper</span> <span class="pre">%}</span></tt> までの内容を大文字に変換できるようにします。</p>
<p>使い方はこのようになります:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">upper</span> <span class="cp">%}</span>This will appear in uppercase, <span class="cp">{{</span> <span class="nv">your_name</span> <span class="cp">}}</span>.<span class="cp">{%</span> <span class="k">endupper</span> <span class="cp">%}</span>
</pre></div>
<p>これmでの例と同様、 <tt class="docutils literal"><span class="pre">parser.parse()</span></tt> を使います。ただし、今回は得られた
<tt class="docutils literal"><span class="pre">nodelist</span></tt> を <tt class="docutils literal"><span class="pre">Node</span></tt> に渡します:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">do_upper</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s">&#39;endupper&#39;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">UpperNode</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UpperNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span> <span class="o">=</span> <span class="n">nodelist</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">UpperNode.render()</span></tt> の <tt class="docutils literal"><span class="pre">self.nodelist.render(context)</span></tt> が、新たに導入
されたコンセプトを表しています。</p>
<p>複雑なレンダリングについて他にも例を見たければ、 <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></tt> や
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}</span></tt>, <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">ifequal</span> <span class="pre">%}</span></tt> , <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">ifchanged</span> <span class="pre">%}</span></tt> のソースを参照してく
ださい。ソースは <tt class="docutils literal"><span class="pre">django/template/defaulttags.py</span></tt> にあります。</p>
</div>
</div>
</div>
</div>


          </div>         
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3>Table Of Contents</h3>
            <ul>
<li><a class="reference external" href="">テンプレートタグやフィルタを自作する</a><ul>
<li><a class="reference external" href="#id2">はじめに</a><ul>
<li><a class="reference external" href="#id3">コードの配置</a></li>
<li><a class="reference external" href="#id4">カスタムのテンプレートフィルタ</a><ul>
<li><a class="reference external" href="#id5">テンプレートフィルタに文字列だけを処理させる</a></li>
<li><a class="reference external" href="#id6">カスタムフィルタを登録する</a></li>
<li><a class="reference external" href="#id7">フィルタと自動エスケープ</a></li>
</ul>
</li>
<li><a class="reference external" href="#id8">カスタムテンプレートタグを書く</a><ul>
<li><a class="reference external" href="#id9">テンプレートタグの概要</a></li>
<li><a class="reference external" href="#id10">コンパイル関数を書く</a></li>
<li><a class="reference external" href="#id11">レンダラを書く</a></li>
<li><a class="reference external" href="#id12">自動エスケープについての注意点</a></li>
<li><a class="reference external" href="#id13">タグの登録</a></li>
<li><a class="reference external" href="#id14">テンプレート変数をタグに渡す</a></li>
<li><a class="reference external" href="#id15">簡単なタグへのショートカット</a></li>
<li><a class="reference external" href="#id16">埋め込みタグ</a></li>
<li><a class="reference external" href="#id17">コンテキスト中の変数を設定する</a></li>
<li><a class="reference external" href="#parsing-until-another-block-tag">Parsing until another block tag</a></li>
<li><a class="reference external" href="#id19">他のブロックタグに到達するまでパージングする</a></li>
<li><a class="reference external" href="#id20">次のブロックタグまでパージングして、内容を保存する</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>前後のページ</h3>
  <ul>
    
      <li>前: <a href="custom-model-fields.html">カスタムのモデルフィールド</a></li>
    
    
      <li>次: <a href="custom-file-storage.html">カスタムのストレージシステムを作成する</a></li>
    
  </ul>
  <h3>現在のページ:</h3>
  <ul>
      <li>
        <a href="../index.html">Django v1.0 documentation</a>
        
          <ul><li><a href="index.html">HOWTO ガイド</a>
        
        <ul><li>テンプレートタグやフィルタを自作する</li></ul>
        </li></ul>
      </li>
  </ul>  

            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/howto/custom-template-tags.txt">Show Source</a></li>
            </ul>
            <h3>Quick search</h3>
            <form class="search" action="../search.html" method="get">
              <input type="text" name="q" size="18" /> <input type="submit" value="Go" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">Aug 31, 2012</p>
          </div> 
        
      
    </div>
    
    <div id="ft">
      <div class="nav">
    &laquo; <a href="custom-model-fields.html" title="カスタムのモデルフィールド">前へ</a> 
     |
    <a href="index.html" title="HOWTO ガイド" accesskey="U">上へ</a>
   |
    <a href="custom-file-storage.html" title="カスタムのストレージシステムを作成する">次へ</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>